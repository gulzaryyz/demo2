<!DOCTYPE html>
<html>
<head>
  <title>GitHub Login Bridge</title>
  <meta charset="UTF-8">
</head>
<body>
  <h2>üîê Checking login session...</h2>
  <div id="status">‚è≥ Checking for existing session...</div>

  <script>
    // === Config ===
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxreJeaBJpGY18hKfsOjOpGePfmoGjZuVsTXl0ehCtmnjWlXyA2GdrZadJw_5S3F7fK/exec";
    
    const ISM_REDIRECT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?page=ism-e-azam";

    // === Helper functions ===
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
      return null;
    }

    function setCookie(name, value, days = 30) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    function redirectToISMPage(userId, token) {
      const finalURL = `${ISM_REDIRECT_URL}&userId=${encodeURIComponent(userId)}&token=${encodeURIComponent(token)}`;
      document.getElementById("status").innerText = "‚úÖ Redirecting to secure page...";
      window.location.href = finalURL;
    }

    // === Main Logic ===
    const userId = getCookie("userId");
    const token = getCookie("token");

    if (userId && token) {
      document.getElementById("status").innerText = "‚úÖ Session found. Redirecting...";
      redirectToISMPage(userId, token);
    } else {
      document.getElementById("status").innerText = "üîê No session. Requesting from GAS...";

      // Load iframe to request session from GAS
      const iframe = document.createElement("iframe");
      iframe.src = `${GAS_URL}?page=UserAccessControl`;
      iframe.style.display = "none";
      document.body.appendChild(iframe);

      // Listen for postMessage from GAS iframe
      window.addEventListener("message", function(event) {
        // Optional: verify origin if known
        // if (!event.origin.includes("script.google.com")) return;

        const { userId, token } = event.data || {};
        if (userId && token) {
          setCookie("userId", userId);
          setCookie("token", token);
          redirectToISMPage(userId, token);
        } else {
          document.getElementById("status").innerText = "‚ùå Failed to get session.";
        }
      }, false);
    }
  </script>
</body>
</html>
