<!DOCTYPE html>
<html>
<head>
  <title>GitHub Cookie Bridge</title>
</head>
<body>
  <h2>Loading authentication...</h2>

  <script>
    // --- Helper functions ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
      return null;
    }

    function setCookie(name, value, days = 30) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    function redirectToISMPage(userId, token) {
      const gasURL = "https://script.google.com/macros/s/AKfycbXXXXXX/exec";
      const redirectURL = `${gasURL}?userId=${userId}&token=${token}`;
      window.location.href = redirectURL;
    }

    // --- Main logic ---
    const userId = getCookie("userId");
    const token = getCookie("token");

    if (userId && token) {
      console.log("âœ… Cookies found, redirecting...");
      redirectToISMPage(userId, token);
    } else {
      console.log("ðŸ”’ Cookies missing. Loading fallback...");
      const iframe = document.createElement("iframe");
      iframe.src = "https://script.google.com/macros/s/AKfycbXXXXXX/exec?page=UserAccessControl";
      iframe.style.display = "none";
      document.body.appendChild(iframe);

      window.addEventListener("message", (event) => {
        if (event.origin.includes("script.google.com") && event.data?.userId && event.data?.token) {
          console.log("âœ… Received credentials from GAS:", event.data);
          setCookie("userId", event.data.userId);
          setCookie("token", event.data.token);
          redirectToISMPage(event.data.userId, event.data.token);
        }
      });
    }
  </script>
</body>
</html>
