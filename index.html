<!DOCTYPE html>
<html>
<head>
  <title>GitHub Login Bridge</title>
  <meta charset="UTF-8">
</head>
<body>
  <h2>üîê Checking login session...</h2>
  <div id="status">‚è≥ Checking for existing session...</div>
  <button onclick="showCookies()">üß™ Check Cookies</button>

  <script>
    // === Config ===
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyIrRux_SfzQlA0UHxjFc5G-Plx1M8Yle1rkYkR51tkykkIGEdRfYe5llk6EiUjvKl8/exec";
    const ISM_REDIRECT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?page=ism-e-azam";

    // === Helper Functions ===
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
      return null;
    }

    function setCookie(name, value, days = 30) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function redirectToISMPage(userId, token) {
      const finalURL = `${ISM_REDIRECT_URL}&userId=${encodeURIComponent(userId)}&token=${encodeURIComponent(token)}`;
      document.getElementById("status").innerText = "‚úÖ Redirecting to secure page...";
      window.location.href = finalURL;
    }

    // === Show Cookies Button Function ===
    function showCookies() {
      const uid = getCookie("userId");
      const tok = getCookie("token");
      alert(`üß™ userId: ${uid || "(not found)"}\ntoken: ${tok || "(not found)"}`);
    }

    // === Main Logic ===
    let userId = getCookie("userId");
    let token = getCookie("token");

    if (!userId || !token) {
      const urlUserId = getQueryParam("userId");
      const urlToken = getQueryParam("token");

      if (urlUserId && urlToken) {
        setCookie("userId", urlUserId);
        setCookie("token", urlToken);
        userId = urlUserId;
        token = urlToken;
      }
    }

    if (userId && token) {
      alert(222)
      document.getElementById("status").innerText = "‚úÖ Session found. Redirecting...";
      redirectToISMPage(userId, token);
    } else {
      alert(1111)
      document.getElementById("status").textContent = "üîÅ Redirecting to GAS for session creation...";
      window.location.href = GAS_URL;
    }
  </script>
</body>
</html>
